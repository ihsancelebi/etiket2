<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>THE ICONE - Etiket ve Barkod Oluşturucu</title>

  <!-- Barkod kütüphanesi -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
  <!-- Excel okuma için SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex; gap: 30px; align-items: flex-start;
    }
    .container, .preview-container {
      background: white; border-radius: 15px;
      padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 600; }
    input[type="text"], input[type="number"], input[type="file"] {
      width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
    }
    .btn {
      background: linear-gradient(45deg, #27ae60, #2ecc71);
      color: white; border: none;
      padding: 12px 25px; border-radius: 8px;
      cursor: pointer; font-size: 14px; font-weight: 600;
      margin-top: 10px; transition: all 0.3s ease;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }

    .label-preview { position: relative; width: 113.39px; height: 226.77px; background: white; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
    .label-preview::after { content: ""; position: absolute; bottom: 20mm; left: 0; width: 100%; border-bottom: 1px dashed #aaa; }
    .label-content { padding: 4mm 1.5mm 1.5mm; text-align: center; }
    .logo-image { max-width: 80%; margin-bottom: 4mm; }
    .length-section span { font-size: 5mm; font-weight: 700; display: block; margin-bottom: 2mm; }
    .product-info span { display: block; }
    .barcode-section { margin-top: 2mm; }

    .preview-container { display: flex; flex-direction: column; align-items: center; }
    .label-preview-print-wrapper { display: none; }

    @media print {
      body { background: white; margin:0; padding:0; }
      .container, .preview-container { display: none; }
      .label-preview-print-wrapper {
        display: block !important;
        width: 40mm; height: 80mm;
        page-break-after: always; margin: 0; padding: 0;
      }
      .label-preview {
        width: 40mm; height: 80mm; margin:0; padding:0;
      }
      .label-preview::after { border-color:#000; }
      .label-content { padding:4mm 1.5mm 1.5mm; }
      #detayText { font-size:4mm; }
      .barcode-canvas { max-width: 90%; height: 16mm; }
    }
  </style>
</head>

<body>
  <div class="container">
    <form id="labelForm">
      <div class="form-group">
        <label for="renk">Renk:</label>
        <input type="text" id="renk" placeholder="Örn: Doğal" required>
      </div>
      <div class="form-group">
        <label for="uzunluk">Uzunluk (cm):</label>
        <input type="number" id="uzunluk" min="1" step="1" value="70" required>
      </div>
      <div class="form-group">
        <label for="gramaj">Gramaj (gr):</label>
        <input type="number" id="gramaj" min="0.1" step="0.1" value="0.8" required>
      </div>
      <div class="form-group">
        <label for="fiyat">Fiyat (TL):</label>
        <input type="number" id="fiyat" min="0" step="0.01" value="110" required>
      </div>
      <div class="form-group">
        <label for="stokNo">Stok No (Barkod için):</label>
        <input type="text" id="stokNo" placeholder="Otomatik oluşturulacak">
      </div>

      <!-- Excel Şablonu Yükleme -->
      <div class="form-group">
        <label for="excelFile">Excel Şablonu (xlsx):</label>
        <input type="file" id="excelFile" accept=".xlsx" />
      </div>
    </form>

    <button class="btn" onclick="updatePreview()">Önizleme Güncelle</button>
    <button class="btn" onclick="printLabel()">Tek Etiket Yazdır</button>
    <button class="btn" type="button" onclick="printFromExcel(event)">Excel’den Toplu Yazdır</button>
  </div>

  <div class="preview-container">
    <h1>Önizleme</h1>
    <div class="label-preview" id="labelPreviewHost">
      <div class="label-content">
        <div class="brand-section">
          <img id="logoImage" class="logo-image" src="logo.png" alt="THE ICONE Logo">
        </div>
        <div class="length-section">
          <span id="uzunlukText">70 cm</span>
        </div>
        <div class="product-info">
          <span id="renkText">Doğal</span>
          <span id="detayText">0.8 gr – 110 TL</span>
        </div>
        <div class="barcode-section">
          <svg class="barcode-canvas" id="barcodeCanvas"></svg>
        </div>
      </div>
    </div>
    <div class="label-preview-print-wrapper"></div>
  </div>

  <script>
    // Mevcut güncelleme, önizleme ve tek yazdırma fonksiyonlarınız...
    function updatePreview() {
      const renk   = document.getElementById('renk').value.trim();
      const uzun   = document.getElementById('uzunluk').value;
      const gram   = document.getElementById('gramaj').value;
      const fiyat  = document.getElementById('fiyat').value;
      const stokIn = document.getElementById('stokNo');
      if (!stokIn.value.trim()) stokIn.value = generateStockNo();

      document.getElementById('uzunlukText').textContent = `${uzun} cm`;
      document.getElementById('renkText').textContent    = renk;
      document.getElementById('detayText').textContent   = `${gram} gr – ${fiyat} TL`;

      const bc = document.getElementById('barcodeCanvas'),
            no = stokIn.value.trim();
      bc.innerHTML = '';
      try {
        JsBarcode(bc, no, {
          format: "CODE128",
          width: 1.5, height: 60,
          displayValue: true, fontSize: 10,
          textMargin: 5, margin: 2
        });
      } catch(e) {
        console.error('Barkod oluşturulamadı:', e);
      }
    }

    function printLabel() {
      updatePreview();
      window.print();
    }

    function generateStockNo() {
      return 'IC' + Date.now().toString(36).toUpperCase();
    }

    // Excel’den toplu yazdırma fonksiyonu
    async function printFromExcel(event) {
      event.preventDefault();
      const fileInput = document.getElementById('excelFile');
      if (!fileInput.files.length) {
        alert('Lütfen önce bir Excel dosyası seçin.');
        return;
      }

      const data = await fileInput.files[0].arrayBuffer();
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      const headers = rows.shift();
      const idx = {
        renk:   headers.indexOf('Renk'),
        uzun:   headers.indexOf('Uzunluk'),
        gram:   headers.indexOf('Gramaj'),
        fiyat:  headers.indexOf('Fiyat'),
        stokNo: headers.indexOf('StokNo'),
      };

      const wrapper = document.querySelector('.label-preview-print-wrapper');
      wrapper.innerHTML = '';

      rows.forEach(row => {
        if (row.length < headers.length) return;
        const clone = document.getElementById('labelPreviewHost').cloneNode(true);
        clone.style.display = 'block';
        clone.querySelector('#renkText').textContent    = row[idx.renk]   || '';
        clone.querySelector('#uzunlukText').textContent = `${row[idx.uzun]} cm` || '';
        clone.querySelector('#detayText').textContent   = `${row[idx.gram]} gr – ${row[idx.fiyat]} TL`;
        const svg = clone.querySelector('.barcode-canvas');
        const code = row[idx.stokNo] || generateStockNo();
        JsBarcode(svg, code, {
          format: "CODE128",
          width: 1.5, height: 60,
          displayValue: true, fontSize: 10,
          textMargin: 5, margin: 2
        });
        wrapper.appendChild(clone);
      });

      // Yazdırma
      setTimeout(() => window.print(), 200);
    }

    window.addEventListener('load', () => {
      ['renk','uzunluk','gramaj','fiyat','stokNo'].forEach(id => {
        document.getElementById(id).addEventListener('input', updatePreview);
      });
      setTimeout(updatePreview, 100);
      if (typeof JsBarcode === 'undefined') {
        alert('Barkod kütüphanesi yüklenemedi.');
      }
    });
  </script>
</body>
</html>
